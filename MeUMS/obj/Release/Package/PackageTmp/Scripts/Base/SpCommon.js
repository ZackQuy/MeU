Sp.Common={};Sp.Common.CalculateVolume=function(a){var b=null;a.length>0&&(a=Sp.Globe.GetInstance().GetAnalysis().CalculateVolume(a,10),b={RemovedCubicMeters:a.RemovedCubicMeters,AddedCubicMeters:a.AddedCubicMeters});return b};Sp.Common.getGroupId=function(a,b){for(var c=Sp.Globe.GetInstance().GetPrjTree(),d=0,e=c.GetNextItem(b,11);e>0;){var g=c.GetItemName(e);if(c.IsGroup(e)&&g==a){d=e;break}e=c.GetNextItem(e,13)}d==0&&(d=c.CreateLockedGroup(a,b));return d};
Sp.Common.FeaturesToJson=function(a){for(var b=[],c=0,d=0;d<a.length;d++){var e={};if(c==0)c=a[0].FeatureAttributes.Count;for(var g=0;g<c;g++)e[a[d].FeatureAttributes(g).Name]=a[d].FeatureAttributes(g).Value;e[WKT]=a[d].Geometry.Wks.ExportToWKT();b.push(e)}return b};Sp.Common.GetHiddenGroup=function(a,b){var c="hiddenTemp";b!=void 0&&b!=""&&(c=b);var d=a.GetParam(450),e=a.GetParam(451);d=a.GetPrjTree().FindItem(d+"\\"+c);d==0&&(d=a.GetPrjTree().CreateLockedGroup(c,e));return d};
Sp.Common.ClearHiddenGroup=function(a,b){var c="hiddenTemp";b!=void 0&&b!=""&&(c=b);var d=a.GetParam(450);a.GetParam(451);try{var e=a.GetPrjTree().FindItem(d+"\\"+c);return e>0?(a.GetPrjTree().DeleteItem(e),!0):!1}catch(g){return!1}};
Sp.Common.ModelsHighLight=function(a,b,c){var d=a.GetCreator();if(b.length>0&&b[0]!=null){var e=b[b.length-1].Terrain.BBox;if(e.MaxX-e.MinX!=0){var g="";g=c!=void 0&&c!=""?Sp.Common.GetHiddenGroup(a):Sp.Common.GetHiddenGroup(a,c);for(c=0;c<b.length;c++)if(b[c]!=null){var f=b[c].Position.Yaw;b[c].Position.Yaw=0;e=b[c].Terrain.BBox;var h=String.format("POLYGON(({0} {1},{0} {3},{2} {3},{2} {1},{0} {1}))",e.MinX,e.MinY,e.MaxX,e.MaxY);h=d.GeometryCreator.CreateGeometryFromWKT(h);e=d.Create3DPolygon(h,
e.MaxHeight-e.MinHeight,d.CreateColor(255,255,0,255),d.CreateColor(0,255,0,0),0,g,"box");b[c].Position.Yaw=f;e.Position.Yaw=b[c].Position.Yaw;e.Position.Altitude=b[c].Position.Altitude}}else window.setTimeout(function(){Sp.Common.ModelsHighLight(a,b)},500)}};
Sp.Common.FeatureToModels=function(a,b,c,d){var e=c.GetPrjTree(),g=c.GetCreator(),f=e.GetLayer(a).FeatureGroups;a="";e=[];if(f.Count>0){a=f(0).GetProperty("File Name");var h=/^http:\/\/.*/;h.test(a)||(a="")}f="";f=d!=void 0&&d!=""?Sp.Common.GetHiddenGroup(c):Sp.Common.GetHiddenGroup(c,d);d=0;if(b.length>0&&d==0)d=b[0].FeatureAttributes.Count;for(var j=0;j<b.length;j++){var i=b[j];if(i.Geometry.GeometryType==0){for(h=0;h<d;h++)if(i.FeatureAttributes(h).Name=="path"){a=i.FeatureAttributes(h).Value;
break}h=/^http:\/\/.*/;h.test(a)||(a="");if(a!="")h=c.GetWindow().GetMouseInfo(),h=c.GetWindow().PixelToWorld(h.X,h.Y,0).Position,h.X=i.Geometry.X,h.Y=i.Geometry.Y,h.AltitudeType=0,h.Altitude=0,h.Yaw=0,i=g.CreateModel(h,a,1,0,f,"\u6a21\u578b"),e.push(i)}}return e};
Sp.Common.activateInternetLicence=function(){var a=Sp.Globe.GetInstance(),b=a.GetCreator().CreatePosition(-122.4946,37.78816,100,0,0,0,0,5E3),c=a.GetCreator().CreateColor(0,255,0,127);b=a.GetCreator().CreateCircle(b,200,4294901760,c,0,"Circle");a.GetCreator().DeleteObject(b.ID)};Sp.Common.MapExtendToGlobePos=function(a,b){var c=b.xmin,d=b.xmax,e=b.getCenter(),g=e.x;e=e.y;c=Math.abs((d-c)/2*40009880/360)/Math.tan(26.5*(3.14/180));return a.GetCreator().CreatePosition(g,e,c==0?2E3:c,0,0,-90,0,0)};
Sp.Common.GlobePosToMapExtend=function(a){var b=a.GetWindow().CenterPixelToWorld().Position;a=a.GetNavigate().GetPosition().Altitude*Math.tan(26.5*(3.14/180));a=a/2/3.14/6371004*360/2;return new esri.geometry.Extent(b.x-a,b.y-a,b.x+a,b.y+a,new esri.SpatialReference({wkid:4326}))};
Sp.Common.Abspath=function(){var a=unescape(window.location.href),b=a.indexOf("?");b>0&&(a=a.substr(0,b-1));b=a.lastIndexOf("/");var c=a.lastIndexOf("\\");b=b>c?b:c;if(b<=0)return a;a=a.substring(0,b);a.substring(0,1)=="/"&&(a=a.slice(1));b=/file:\/\/\//gi;a.match(b)!=null&&(a=a.replace(b,""));return a};
Sp.Common.GetParamValue=function(a,b){var c=document.location.href.split("?");if(c.length<=1)return b;c=c[1].split("&");for(var d=0;d<c.length;d++)if(c[d].indexOf(a)==0&&c[d].indexOf("=")==a.length)return c=c[d].split("="),c[1];return b};Sp.Common.CheckNumber=function(a,b){if(a.value!=""){if(isNaN(a.value)==!0)a.value=b,alert("\u4f60\u8f93\u5165\u7684\u4e0d\u662f\u6570\u5b57\u578b")}else a.value=b,alert("\u8f93\u5165\u6846\u4e0d\u5141\u8bb8\u4e3a\u7a7a\uff01")};
Sp.Common.GetHeight=function(a,b){var c=Sp.Globe.GetInstance().GetTerrain(),d=c.GetGroundHeightInfo(a,b,2,0);return c.GetGroundHeightInfo(a,b,2,1).Position.Altitude-d.Position.Altitude};
Sp.Common.CreateMessage=function(a,b,c,d,e,g){var f=!1;if(null!=a)if(f=Sp.Globe.GetInstance(),b==void 0||b=="")f=!1;else{c=c==null?"\u5bf9\u8c61\u7684\u8be6\u7ec6\u4fe1\u606f":c;var h=0;d==1&&/^http:\/\/.*/.test(b)&&(h=1);d=200;e!=null&&e!=""&&!isNaN(e)&&(d=parseFloat(e));e=150;g!=null&&g!=""&&!isNaN(g)&&(e=parseFloat(g));b=f.GetTE5().GetObjectManager().CreateMessage(5,b,h,34,c,-1,2,2,d,e,1);a.Message.MessageID=b.ID;f=!0}return f};var PointIPosition6,RayPointIPosition6,PolygonPointsIPosition6;
Sp.Common.InputPointAndPolygon=function(a){RayPointIPosition6.Init(a.X,a.Y,a.Altitude,a.Yaw,a.Pitch,a.Roll,a.AltitudeType,a.Distance)};Sp.Common.CheckPointInPolygon2DBox=function(a,b){for(var c=b(0).X,d=b(0).Y,e=b(0).X,g=b(0).Y,f=1;f<b.Count;f++){if(b(f).X<c)c=b(f).X;if(b(f).Y<d)d=b(f).Y;if(b(f).X>e)e=b(f).X;if(b(f).Y>g)g=b(f).Y}return c<a.X&&a.X<e&&d<a.Y&&a.Y<g?(RayPointIPosition6.X=e,!0):!1};
Sp.Common.CheckLineCross2DBox=function(a,b,c,d){if(d.Y==c.Y)return!1;var e,g,f;c.X>d.X?(e=c.X,g=d.X):(g=c.X,e=d.X);c.Y>d.Y?(c=c.Y,f=d.Y):(f=c.Y,c=d.Y);return a.Y>=f&&a.Y<=c&&a.X<=e&&b.X>=g?!0:!1};Sp.Common.CheckLineCrossLine=function(a,b,c,d){a=(a.X-c.X)*(d.Y-c.Y)-(d.X-c.X)*(a.Y-c.Y);if(a==0)return!1;return a*((d.X-c.X)*(b.Y-c.Y)-(b.X-c.X)*(d.Y-c.Y))>=0?!0:!1};
Sp.Common.IsPointInPolygon=function(a,b,c){PointIPosition6=a;RayPointIPosition6=b;PolygonPointsIPosition6=c;Sp.Common.InputPointAndPolygon(a);if(!Sp.Common.CheckPointInPolygon2DBox(PointIPosition6,PolygonPointsIPosition6))return!1;for(b=a=0;b<PolygonPointsIPosition6.Count-1;b++)Sp.Common.CheckLineCross2DBox(PointIPosition6,RayPointIPosition6,PolygonPointsIPosition6(b),PolygonPointsIPosition6(b+1))&&Sp.Common.CheckLineCrossLine(PointIPosition6,RayPointIPosition6,PolygonPointsIPosition6(b),PolygonPointsIPosition6(b+
1))&&(PolygonPointsIPosition6(b+1).Y>PolygonPointsIPosition6(b).Y?a++:a--);return a==0?!1:!0};
